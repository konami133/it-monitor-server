<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Enterprise Monitor (RBAC)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .group-active { background-color: #2563eb; color: white; }
    </style>
</head>
<body class="bg-gray-100 h-screen flex overflow-hidden">

    <div id="loginModal" class="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-96 text-center">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">System Login</h2>
            <input type="text" id="username" placeholder="Username" class="w-full p-3 border bg-gray-50 mb-4 rounded">
            <input type="password" id="password" placeholder="Password" class="w-full p-3 border bg-gray-50 mb-6 rounded">
            <button onclick="login()" class="w-full bg-blue-600 text-white p-3 rounded font-semibold hover:bg-blue-700">LOGIN</button>
        </div>
    </div>

    <div id="dashboardContent" class="hidden w-full h-full flex">
        <aside class="w-64 bg-slate-900 text-slate-300 flex flex-col shadow-xl flex-shrink-0">
            <div class="h-16 flex items-center justify-center border-b border-slate-700 bg-slate-800 text-white font-bold text-xl">
                IT MONITOR
            </div>
            
            <div class="p-4 space-y-1">
                <button onclick="switchView('dashboard')" class="w-full text-left px-4 py-2 hover:bg-slate-800 rounded group-active" id="menu-dash">
                    <i class="fas fa-desktop mr-2"></i> Dashboard
                </button>
                <button onclick="switchView('users')" class="hidden w-full text-left px-4 py-2 hover:bg-slate-800 rounded text-yellow-400" id="menu-users">
                    <i class="fas fa-users-cog mr-2"></i> User Management
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-4 border-t border-slate-800 mt-2">
                <p class="text-xs uppercase text-slate-500 font-bold mb-2">Device Groups</p>
                <button onclick="filterGroup('ALL')" id="btn-ALL" class="w-full text-left px-4 py-2 hover:bg-slate-800 rounded text-sm mb-1">All Devices</button>
                <div id="groupList" class="space-y-1"></div>
            </div>
            <div class="p-4 border-t border-slate-700">
                <div class="text-xs text-gray-500 mb-2">Logged in as: <span id="currentUserDisplay" class="text-white font-bold"></span></div>
                <button onclick="logout()" class="text-red-400 w-full text-left hover:text-red-300"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="h-16 bg-white shadow-sm flex items-center justify-between px-6 z-10">
                <h2 class="text-lg font-semibold text-gray-700" id="headerTitle">Dashboard</h2>
                <div class="h-8 w-8 bg-green-500 rounded-full flex items-center justify-center text-white text-xs font-bold shadow">ON</div>
            </header>

            <main id="view-dashboard" class="flex-1 overflow-x-hidden overflow-y-auto p-6">
                <div class="grid grid-cols-3 gap-6 mb-6">
                    <div class="bg-white p-5 rounded border-l-4 border-blue-500 shadow-sm"><div>Total</div><div class="text-2xl font-bold" id="totalCount">0</div></div>
                    <div class="bg-white p-5 rounded border-l-4 border-green-500 shadow-sm"><div>Online</div><div class="text-2xl font-bold text-green-600" id="onlineCount">0</div></div>
                    <div class="bg-white p-5 rounded border-l-4 border-red-500 shadow-sm"><div>Offline</div><div class="text-2xl font-bold text-red-600" id="offlineCount">0</div></div>
                </div>
                <div class="bg-white rounded shadow overflow-hidden">
                    <div class="px-6 py-4 border-b flex justify-between items-center bg-gray-50">
                        <h3 class="font-bold text-gray-700">Device List</h3>
                        <button onclick="fetchDevices()" class="text-blue-500 hover:text-blue-700 text-sm font-medium"><i class="fas fa-sync-alt"></i> Refresh</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full whitespace-no-wrap">
                            <thead>
                                <tr class="bg-gray-100 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                                    <th class="px-6 py-3">Status</th>
                                    <th class="px-6 py-3">Name</th>
                                    <th class="px-6 py-3">Location</th>
                                    <th class="px-6 py-3">Info</th>
                                    <th class="px-6 py-3 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="deviceTable" class="bg-white divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            </main>

            <main id="view-users" class="hidden flex-1 overflow-x-hidden overflow-y-auto p-6">
                <div class="bg-white rounded shadow overflow-hidden">
                    <div class="px-6 py-4 border-b flex justify-between items-center bg-gray-50">
                        <h3 class="font-bold text-gray-700">User Management</h3>
                        <button onclick="openUserModal()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700"><i class="fas fa-plus"></i> Add User</button>
                    </div>
                    <table class="w-full">
                        <thead class="bg-gray-100 text-xs font-bold text-gray-600 uppercase text-left">
                            <tr><th class="px-6 py-3">Username</th><th class="px-6 py-3">Role</th><th class="px-6 py-3">Permissions</th><th class="px-6 py-3 text-center">Manage</th></tr>
                        </thead>
                        <tbody id="userTable" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </main>
        </div>
    </div>

    <div id="detailsModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center">
        <div class="bg-white w-[600px] rounded-lg shadow-2xl p-6 relative">
            <button onclick="document.getElementById('detailsModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold mb-4">Device Specs</h3>
            <div id="detailsContent" class="space-y-2 text-sm"></div>
        </div>
    </div>

    <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg w-96 shadow-xl">
            <h3 class="text-xl font-bold mb-4">Edit Device</h3>
            <input type="hidden" id="editHostname">
            <input type="text" id="editName" class="w-full border p-2 rounded mb-2" placeholder="Friendly Name">
            <input type="text" id="editGroup" class="w-full border p-2 rounded mb-2" placeholder="Group">
            <input type="text" id="editLocation" class="w-full border p-2 rounded mb-4" placeholder="Location">
            <div class="flex justify-end space-x-2">
                <button onclick="document.getElementById('editModal').classList.add('hidden')" class="px-4 py-2 bg-gray-200 rounded">Cancel</button>
                <button onclick="saveDevice()" class="px-4 py-2 bg-blue-600 text-white rounded">Save</button>
            </div>
        </div>
    </div>

    <div id="userModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg w-[500px] shadow-xl">
            <h3 class="text-xl font-bold mb-4" id="userModalTitle">Add User</h3>
            <input type="hidden" id="userId">
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div><label class="text-xs font-bold">Username</label><input type="text" id="formUser" class="w-full border p-2 rounded"></div>
                <div><label class="text-xs font-bold">Password</label><input type="password" id="formPass" class="w-full border p-2 rounded" placeholder="Leave blank to keep"></div>
            </div>
            <div class="mb-4">
                <label class="text-xs font-bold">Role</label>
                <select id="formRole" class="w-full border p-2 rounded" onchange="togglePermissions()">
                    <option value="staff">Staff</option>
                    <option value="admin">System Admin</option>
                </select>
            </div>
            <div class="mb-4 p-3 bg-gray-50 rounded border" id="permSection">
                <label class="text-xs font-bold block mb-2">Permissions (for Staff)</label>
                <div class="space-y-2">
                    <label class="flex items-center"><input type="checkbox" class="perm-chk mr-2" value="edit_device"> Edit Device Info (Name, Loc)</label>
                    <label class="flex items-center"><input type="checkbox" class="perm-chk mr-2" value="control_device"> Control (Reboot/Shutdown)</label>
                    <label class="flex items-center"><input type="checkbox" class="perm-chk mr-2" value="delete_device"> Delete Device</label>
                </div>
            </div>
            <div class="flex justify-end space-x-2">
                <button onclick="document.getElementById('userModal').classList.add('hidden')" class="px-4 py-2 bg-gray-200 rounded">Cancel</button>
                <button onclick="saveUser()" class="px-4 py-2 bg-blue-600 text-white rounded">Save</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://it-monitor-server.onrender.com/api"; 
        let globalDevices = [];
        let globalUsers = [];
        let currentUser = null; // { username, role, permissions }

        // --- AUTH ---
        async function login() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            try {
                const res = await fetch(`${API_URL}/login`, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({username:u, password:p}) 
                });
                if(res.ok) {
                    const data = await res.json();
                    localStorage.setItem('token', data.token);
                    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå UI
                    currentUser = { username: u, role: data.role, permissions: data.permissions || [] };
                    localStorage.setItem('userConfig', JSON.stringify(currentUser));
                    
                    initSystem();
                } else alert("Login Failed");
            } catch(e) { alert("Error: " + e); }
        }

        function logout() {
            localStorage.clear();
            location.reload();
        }

        function initSystem() {
            const token = localStorage.getItem('token');
            const savedUser = localStorage.getItem('userConfig');
            if(token && savedUser) {
                currentUser = JSON.parse(savedUser);
                document.getElementById('loginModal').classList.add('hidden');
                document.getElementById('dashboardContent').classList.remove('hidden');
                document.getElementById('currentUserDisplay').innerText = `${currentUser.username} (${currentUser.role})`;
                
                // Show/Hide Admin Menus
                if(currentUser.role === 'admin' || currentUser.permissions.includes('manage_users')) {
                    document.getElementById('menu-users').classList.remove('hidden');
                }

                fetchDevices();
                setInterval(fetchDevices, 5000);
            }
        }

        // --- UI SWITCHING ---
        function switchView(view) {
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-users').classList.add('hidden');
            document.getElementById(`view-${view}`).classList.remove('hidden');
            
            // Highlight Menu
            document.querySelectorAll('aside button').forEach(b => b.classList.remove('group-active'));
            document.getElementById(`menu-${view === 'dashboard' ? 'dash' : 'users'}`).classList.add('group-active');

            if(view === 'users') fetchUsers();
        }

        // --- DEVICE LOGIC ---
        async function fetchDevices() {
            const token = localStorage.getItem('token'); if(!token) return;
            try {
                const res = await fetch(`${API_URL}/devices`, { headers: { 'Authorization': `Bearer ${token}` }});
                if(res.ok) {
                    globalDevices = await res.json();
                    renderTable();
                }
            } catch(e) {}
        }

        function hasPerm(perm) {
            if(!currentUser) return false;
            if(currentUser.role === 'admin') return true;
            return currentUser.permissions.includes(perm);
        }

        function renderTable() {
            const tbody = document.getElementById('deviceTable'); 
            tbody.innerHTML = '';
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Stats (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
            document.getElementById('totalCount').innerText = globalDevices.length;
            document.getElementById('onlineCount').innerText = globalDevices.filter(d => d.status === 'online').length;
            document.getElementById('offlineCount').innerText = globalDevices.filter(d => d.status !== 'online').length;

            globalDevices.forEach(d => {
                const isOnline = d.status === 'online';
                // üîí ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏° Permission
                let buttons = `
                    <button onclick="openDetails('${d.hostname}')" class="text-blue-600 bg-blue-50 p-2 rounded hover:bg-blue-100" title="View"><i class="fas fa-eye"></i></button>
                `;

                if(hasPerm('edit_device')) {
                    buttons += `<button onclick="openEdit('${d.hostname}')" class="text-gray-500 bg-gray-100 p-2 rounded hover:bg-gray-200 ml-1"><i class="fas fa-edit"></i></button>`;
                }
                
                if(hasPerm('control_device') && isOnline) {
                    buttons += `
                        <button onclick="sendCommand('${d.hostname}','reboot')" class="text-orange-500 bg-orange-50 p-2 rounded hover:bg-orange-100 ml-1"><i class="fas fa-sync"></i></button>
                        <button onclick="sendCommand('${d.hostname}','shutdown')" class="text-red-500 bg-red-50 p-2 rounded hover:bg-red-100 ml-1"><i class="fas fa-power-off"></i></button>
                    `;
                }

                if(hasPerm('delete_device')) {
                    buttons += `<button onclick="deleteDevice('${d.hostname}')" class="text-red-400 bg-red-50 p-2 rounded hover:bg-red-100 ml-1"><i class="fas fa-trash"></i></button>`;
                }

                const statusBadge = isOnline ? `<span class="bg-green-100 text-green-800 text-xs font-bold px-2 py-1 rounded">ONLINE</span>` : `<span class="bg-red-100 text-red-800 text-xs font-bold px-2 py-1 rounded">OFFLINE</span>`;

                const row = `
                    <tr class="hover:bg-gray-50 border-b border-gray-100">
                        <td class="px-6 py-4">${statusBadge}</td>
                        <td class="px-6 py-4">
                            <div class="font-bold text-gray-800 text-sm">${d.friendlyName || d.hostname}</div>
                            <div class="text-xs text-gray-400 font-mono">${d.hostname}</div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-600">${d.group || '-'} / ${d.location || '-'}</td>
                        <td class="px-6 py-4 text-xs">
                            <div>CPU: ${d.cpu || '0%'} | RAM: ${d.ram || '0%'}</div>
                            <div class="text-gray-400">${d.ip || ''}</div>
                        </td>
                        <td class="px-6 py-4 text-center flex justify-center">${buttons}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // --- ACTIONS (Devices) ---
        function openEdit(hostname) {
            const d = globalDevices.find(x => x.hostname === hostname);
            document.getElementById('editHostname').value = hostname;
            document.getElementById('editName').value = d.friendlyName || '';
            document.getElementById('editGroup').value = d.group || '';
            document.getElementById('editLocation').value = d.location || '';
            document.getElementById('editModal').classList.remove('hidden');
        }

        async function saveDevice() {
            const body = {
                hostname: document.getElementById('editHostname').value,
                friendlyName: document.getElementById('editName').value,
                group: document.getElementById('editGroup').value,
                location: document.getElementById('editLocation').value
            };
            await fetch(`${API_URL}/devices/update`, { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('token')}`},
                body: JSON.stringify(body)
            });
            document.getElementById('editModal').classList.add('hidden');
            fetchDevices();
        }

        async function sendCommand(hostname, cmd) {
            if(!confirm(`Confirm ${cmd} ${hostname}?`)) return;
            await fetch(`${API_URL}/devices/command`, { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('token')}`},
                body: JSON.stringify({hostname, command: cmd})
            });
            alert("Command Sent");
        }

        async function deleteDevice(hostname) {
            if(!confirm(`Delete ${hostname}?`)) return;
            await fetch(`${API_URL}/devices/${hostname}`, { 
                method: 'DELETE', 
                headers: {'Authorization': `Bearer ${localStorage.getItem('token')}`}
            });
            fetchDevices();
        }

        function openDetails(hostname) {
            const d = globalDevices.find(x => x.hostname === hostname);
            // ... (‡πÉ‡∏™‡πà code ‡πÅ‡∏™‡∏î‡∏á details ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
            document.getElementById('detailsContent').innerHTML = `
                <p><b>OS:</b> ${d.os}</p>
                <p><b>CPU:</b> ${d.cpu_model}</p>
                <p><b>RAM:</b> ${d.ram_type || ''} ${d.ram_total}</p>
                <p><b>IP/MAC:</b> ${d.ip} / ${d.mac_address}</p>
            `;
            document.getElementById('detailsModal').classList.remove('hidden');
        }

        // --- USER MANAGEMENT ---
        async function fetchUsers() {
            const res = await fetch(`${API_URL}/users`, { headers: {'Authorization': `Bearer ${localStorage.getItem('token')}`} });
            if(res.ok) {
                globalUsers = await res.json();
                const tbody = document.getElementById('userTable');
                tbody.innerHTML = '';
                globalUsers.forEach(u => {
                    const row = `
                        <tr class="border-b">
                            <td class="px-6 py-4 font-bold text-gray-700">${u.username}</td>
                            <td class="px-6 py-4"><span class="bg-gray-200 px-2 py-1 rounded text-xs font-bold ${u.role==='admin'?'text-blue-700':'text-gray-700'}">${u.role.toUpperCase()}</span></td>
                            <td class="px-6 py-4 text-xs text-gray-500">${u.role==='admin' ? 'ALL ACCESS' : u.permissions.join(', ')}</td>
                            <td class="px-6 py-4 text-center">
                                <button onclick="openUserModal('${u._id}')" class="text-blue-500 hover:text-blue-700 mr-2"><i class="fas fa-edit"></i></button>
                                ${u.username !== 'admin' ? `<button onclick="deleteUser('${u._id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>` : ''}
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }
        }

        function openUserModal(id = null) {
            const modal = document.getElementById('userModal');
            modal.classList.remove('hidden');
            if(id) {
                const u = globalUsers.find(x => x._id === id);
                document.getElementById('userModalTitle').innerText = "Edit User";
                document.getElementById('userId').value = u._id;
                document.getElementById('formUser').value = u.username;
                document.getElementById('formUser').disabled = true; // ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠
                document.getElementById('formPass').value = "";
                document.getElementById('formRole').value = u.role;
                
                // Set Checkboxes
                document.querySelectorAll('.perm-chk').forEach(c => c.checked = u.permissions.includes(c.value));
            } else {
                document.getElementById('userModalTitle').innerText = "Add User";
                document.getElementById('userId').value = "";
                document.getElementById('formUser').value = "";
                document.getElementById('formUser').disabled = false;
                document.getElementById('formPass').value = "";
                document.getElementById('formRole').value = "staff";
                document.querySelectorAll('.perm-chk').forEach(c => c.checked = false);
            }
            togglePermissions();
        }

        function togglePermissions() {
            const role = document.getElementById('formRole').value;
            const permSec = document.getElementById('permSection');
            if(role === 'admin') permSec.classList.add('opacity-50', 'pointer-events-none');
            else permSec.classList.remove('opacity-50', 'pointer-events-none');
        }

        async function saveUser() {
            const id = document.getElementById('userId').value;
            const body = {
                username: document.getElementById('formUser').value,
                password: document.getElementById('formPass').value,
                role: document.getElementById('formRole').value,
                permissions: Array.from(document.querySelectorAll('.perm-chk:checked')).map(c => c.value)
            };
            
            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_URL}/users/${id}` : `${API_URL}/users`;

            await fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('token')}`},
                body: JSON.stringify(body)
            });
            
            document.getElementById('userModal').classList.add('hidden');
            fetchUsers();
        }

        async function deleteUser(id) {
            if(!confirm("Delete this user?")) return;
            await fetch(`${API_URL}/users/${id}`, { method: 'DELETE', headers: {'Authorization': `Bearer ${localStorage.getItem('token')}`} });
            fetchUsers();
        }

        initSystem();
    </script>
</body>
</html>